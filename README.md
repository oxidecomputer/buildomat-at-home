# üè†üî® Buildomat At Home

Ever wished you could emulate a [Buildomat](https://github.com/oxidecomputer/buildomat) job from the comfort of your illumos machine? Here's some code that'll give it a try!

buildomat-at-home sets up the /input and /work datasets, fetches output artefacts from input jobs, and runs your script so that you can test and debug CI scripts without waiting on CI.

## Usage

**Install:**

```sh
cargo install --locked --git https://github.com/oxidecomputer/buildomat-at-home
```

**Run a job without any inputs:**

```sh
buildomat-at-home .github/buildomat/jobs/job-name.sh
```

buildomat-at-home will plan its run and ask you to approve the commands it will run.

If your script runs successfully, buildomat-at-home will snapshot the `/work` directory and give you an input name like `local/01H3XMET848BWFBC9KFRN1KCWX`.

**Run a job with some inputs:**

```sh
buildomat-at-home .github/buildomat/jobs/complex-job.sh https://github.com/oxidecomputer/sample/runs/1234567890 local/01H3XMET848BWFBC9KFRN1KCWX
```

## Limitations

### `rpool` must exist

buildomat-at-home currently (and rudely) assumes you have a ZFS pool named `rpool` that you want it to muck around with.

### `pfexec` must work

In theory this could test Buildomat jobs that use Ubuntu, but right now `pfexec` is hardcoded.

### No `output_rules`/`[[publish]]` verification or filtering

buildomat-at-home does not (currently) attempt to check the outputs listed in `output_rules` or `[[publish]]` were generated by the job, nor does it filter the `/work` directory in snapshots it creates.

### No automatic GitHub tokens

If a job requests `access_repos`, Buildomat generates a GitHub API token and adds it to ~/.netrc. buildomat-at-home makes no attempt to do this. If you're trying to run a job that uses `access_repos`, you probably want to write a ~/.netrc that looks like this:

```
machine github.com
login x-access-token
password ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

machine api.github.com
login x-access-token
password ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

Head to https://github.com/settings/tokens to generate a token.

### Your machine is not the same as the Buildomat image

You probably have all sorts of development tools installed that aren't going to be available in CI. In theory this program could better emulate a Buildomat image with zones, but it doesn't.

### Probably other stuff

Sorry
